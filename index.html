<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÊàëÁöÑËÅñË™ïÂ§úÊÄéÈ∫ºÈÇ£È∫ºÁ¥Ø (ËßíÂ∫¶Âà§ÂÆöÈò≤Ë™§Âà§Áâà)</title>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <style>
    /* ÂÖ®Â±ÄË®≠ÂÆö */
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      text-align: center; 
      background: transparent; 
      color: #fff; 
      margin: 0; 
      overflow: hidden; 
      user-select: none;
      -webkit-user-select: none;
    }

    .container { 
      position: relative; 
      width: 100vw; 
      height: 100vh; 
    }

    video, canvas { 
      position: absolute; 
      top: 0; left: 0; 
      width: 100%; height: 100%; 
      object-fit: cover; 
      transform: scaleX(-1); 
    }

    /* ËÉåÊôØËàáÁâπÊïà */
    .scene-background { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; overflow: hidden; background: #000; }
    .night-sky { position: absolute; top: 0; left: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, #020111 10%, #191d3a 50%, #2d3e5e 90%); }
    .moon { position: absolute; top: 50px; right: 50px; width: 80px; height: 80px; background: #fefcd7; border-radius: 50%; box-shadow: 0 0 20px #fefcd7, 0 0 50px rgba(254, 252, 215, 0.4); }
    .snow-ground { position: absolute; bottom: 0; left: 0; width: 100%; height: 30%; background: #fffafa; border-top: 5px solid #e3e3e3; border-radius: 50% 50% 0 0 / 20px 20px 0 0; }
    .snowflake { position: absolute; top: -10px; width: 10px; height: 10px; background: white; border-radius: 50%; opacity: 0.8; animation: fall linear infinite; }
    @keyframes fall { 0% { top: -10%; transform: translateX(0); } 100% { top: 100%; transform: translateX(20px); } }
    .snowflake:nth-child(2) { width: 8px; height: 8px; animation-duration: 7s; opacity: 0.6; }
    .snowflake:nth-child(3) { width: 12px; height: 12px; animation-duration: 5s; opacity: 0.9; }

    /* UI ‰ªãÈù¢ */
    .score-board { 
      position: absolute; top: 80px; left: 50%; transform: translateX(-50%); z-index: 10; 
      background: rgba(0, 0, 0, 0.6); padding: 10px 40px; border-radius: 20px; 
      border: 1px solid rgba(255, 255, 255, 0.3); pointer-events: none; 
      transition: all 0.1s ease; will-change: transform, box-shadow;
    }
    #count { font-size: 70px; font-weight: 800; color: #fff; line-height: 1; }
    .count-title { font-size: 14px; color: #ccc; letter-spacing: 2px; }
    #status { margin-top: 5px; font-size: 18px; font-weight: bold; color: #ddd; }

    #start-btn { 
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; 
      padding: 25px 50px; font-size: 30px; font-weight: 900; background: linear-gradient(135deg, #007bff, #0056b3); 
      color: white; border: 4px solid rgba(255, 255, 255, 0.5); border-radius: 60px; cursor: pointer; 
      box-shadow: 0 0 30px rgba(0, 123, 255, 0.6); white-space: nowrap; animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } 100% { transform: translate(-50%, -50%) scale(1); } }

    #reset-btn {
      position: absolute; bottom: 100px; right: 20px; z-index: 100;
      background: #ff4757; color: white; border: 2px solid white; padding: 15px 30px; 
      font-size: 18px; font-weight: bold; border-radius: 30px; cursor: pointer; display: none; 
    }
    #reset-btn:active { transform: scale(0.9); }

    .pop-effect { animation: pop 0.1s ease-out; color: #00ff00 !important; }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }

    /* RWD */
    @media (max-height: 500px) and (orientation: landscape) {
      .score-board { top: 10px; left: 20px; transform: none; padding: 5px 20px; }
      #count { font-size: 40px; }
      #start-btn { padding: 15px 30px; font-size: 20px; border-width: 2px; }
      #reset-btn { bottom: auto; top: 10px; right: 20px; padding: 8px 15px; font-size: 14px; }
    }
    @media (min-width: 1024px) {
      .score-board { top: 60px; padding: 20px 80px; border-width: 3px; background: rgba(0, 0, 0, 0.7); left: 50%; transform: translateX(-50%); }
      #count { font-size: 140px; text-shadow: 0 0 30px currentColor; }
    }
    
    /* ÁÅ´ÁÑ∞ÁâπÊïà */
    .fire-lv1 { border-color: #ffd700 !important; color: #ffd700 !important; box-shadow: 0 0 15px rgba(255, 215, 0, 0.6), inset 0 0 10px rgba(255, 215, 0, 0.4); }
    .fire-lv2 { border-color: #ff4500 !important; color: #ff4500 !important; box-shadow: 0 0 30px rgba(255, 69, 0, 0.8), inset 0 0 20px rgba(255, 69, 0, 0.5); }
    .fire-lv3 { border-color: #00ffff !important; color: #00ffff !important; background: rgba(0, 255, 255, 0.1) !important; box-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff, 0 0 60px #fff; }
  </style>
</head>

<body>

  <div class="scene-background">
    <div class="night-sky">
      <div class="moon"></div>
      <div class="snowflake" style="left: 10%;"></div><div class="snowflake" style="left: 30%;"></div>
      <div class="snowflake" style="left: 50%;"></div><div class="snowflake" style="left: 70%;"></div>
    </div>
    <div class="snow-ground"></div>
  </div>

  <div class="container">
    <div class="score-board">
      <div class="count-title">TOTAL HITS</div>
      <div id="count">0</div>
      <div id="status">READY</div>
    </div>

    <div class="video-container">
      <video id="input_video" playsinline style="display:none"></video>
      <canvas id="output_canvas"></canvas>
    </div>

    <button id="start-btn" onclick="initGame()">ü•ä ÈªûÊìäÈñãÂßã (START)</button>
    <button id="reset-btn" onclick="resetCount()">Ê≠∏Èõ∂ÈáçÁΩÆ (RESET)</button>
  </div>

  <script>
    // --- 0. Èü≥ÊïàÁ≥ªÁµ± (Web Audio API) ---
    const PUNCH_SOUND_URL = 'punch.mp3'; 
    let audioContext = null, punchBuffer = null;

    async function loadSound() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
            const response = await fetch(PUNCH_SOUND_URL);
            const arrayBuffer = await response.arrayBuffer();
            punchBuffer = await audioContext.decodeAudioData(arrayBuffer);
            console.log("Èü≥Êïà OK");
        } catch (error) { console.error("Èü≥ÊïàËºâÂÖ•Â§±Êïó", error); }
    }

    function playPunchSound() {
        if (!audioContext || !punchBuffer) return;
        if (audioContext.state === 'suspended') audioContext.resume();
        const source = audioContext.createBufferSource();
        source.buffer = punchBuffer;
        source.connect(audioContext.destination);
        source.start(0);
    }

    // --- 1. ÂèñÂæóÁ∂≤È†ÅÂÖÉÁ¥† ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d', { alpha: false });
    const countElement = document.getElementById('count');
    const scoreBoard = document.querySelector('.score-board'); 
    const statusElement = document.getElementById('status');
    const startBtn = document.getElementById('start-btn'); 
    const resetBtn = document.getElementById('reset-btn'); 

    // --- 2. Áâ©ÁêÜÂèÉÊï∏ (Âö¥Ê†ºÁâà) ---
    const CONFIG = {
        triggerRatio: 0.85, // ÊâãËáÇ‰º∏Â±ïÊØî‰æã (Ë∂äÈ´òË∂äÈÅ†)
        resetRatio: 0.40,   // Êî∂ÂõûÈáçÁΩÆÈªû
        minSpeed: 0.015,    // ÊúÄÂ∞èÈÄüÂ∫¶
        
        // [Êñ∞Â¢û] ËßíÂ∫¶ÈÅéÊøæÔºöÂè™ÊúâÁï∂ÊâãËÇòÊâìÁõ¥Â§ßÊñºÊ≠§ËßíÂ∫¶ÔºåÊâçÁÆóÊîªÊìä
        // 90Â∫¶ÊòØÁõ¥ËßíÔºå180Â∫¶ÊòØÂÖ®Áõ¥„ÄÇË®≠ 125 ÂèØ‰ª•ÈÅéÊøæÊéâÂ§ßÈÉ®ÂàÜÁöÑÊì∫Êû∂Âã¢ËàáË∫´È´îÂâçÂÇæ
        minAngle: 125,      
        
        cooldownFrames: 5 
    };

    let count = 0;
    let leftStage = "down", rightStage = "down";
    let leftCooldown = 0, rightCooldown = 0;
    let floatingTexts = []; 
    let prevLeftWrist = { x: 0, y: 0 }, prevRightWrist = { x: 0, y: 0 };

    // --- 3. Â∑•ÂÖ∑ÂáΩÊï∏ ---
    function calculateDistance(a, b) {
      return Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2));
    }

    // [Êñ∞Â¢û] Ë®àÁÆó‰∏âÈªûËßíÂ∫¶ (ËÇ©ËÜÄ-ÊâãËÇò-ÊâãËÖï)
    function calculateAngle(a, b, c) {
        let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return angle;
    }

    function drawVisualText(ctx, text, visualX, visualY, color) {
      ctx.save();
      ctx.scale(-1, 1); ctx.font = `bold 60px Arial`; ctx.fillStyle = color;
      ctx.fillText(text, -visualX, visualY); 
      ctx.restore();
    }

    function spawnFloatingText(x, y, text, color) {
        if(floatingTexts.length > 20) floatingTexts.shift();
        floatingTexts.push({ x, y, text, color, life: 15, offsetY: 0 });
    }

    function updateFireEffect(currentCount) {
      if (!scoreBoard) return;
      scoreBoard.classList.remove('fire-lv1', 'fire-lv2', 'fire-lv3');
      if (currentCount >= 100) scoreBoard.classList.add('fire-lv3');
      else if (currentCount >= 80) scoreBoard.classList.add('fire-lv2');
      else if (currentCount >= 50) scoreBoard.classList.add('fire-lv1');
    }

    window.resetCount = function() {
      count = 0; countElement.innerText = count; floatingTexts = []; 
      if (scoreBoard) scoreBoard.classList.remove('fire-lv1', 'fire-lv2', 'fire-lv3');
      statusElement.innerText = "RESET OK"; statusElement.style.color = "white";
    }

    // --- 4. Ê†∏ÂøÉÈÇèËºØ ---
    function onResults(results) {
      const targetWidth = Math.min(window.innerWidth, 1280); 
      const targetHeight = targetWidth * (videoElement.videoHeight / videoElement.videoWidth || 0.75);

      if (canvasElement.width !== targetWidth) {
          canvasElement.width = targetWidth; canvasElement.height = targetHeight;
      }
      const cw = canvasElement.width, ch = canvasElement.height;

      canvasCtx.save();
      canvasCtx.clearRect(0, 0, cw, ch);
      canvasCtx.drawImage(results.image, 0, 0, cw, ch);

      for (let i = floatingTexts.length - 1; i >= 0; i--) {
        let ft = floatingTexts[i];
        ft.life--; ft.offsetY -= 5;
        drawVisualText(canvasCtx, ft.text, cw - (ft.x * cw), (ft.y * ch) + ft.offsetY, ft.color);
        if (ft.life <= 0) floatingTexts.splice(i, 1);
      }

      if (leftCooldown > 0) leftCooldown--;
      if (rightCooldown > 0) rightCooldown--;

      if (results.poseLandmarks) {
        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: 'rgba(255, 255, 255, 0.2)', lineWidth: 1});
        
        const lm = results.poseLandmarks;
        const nose = lm[0];
        const leftShoulder = lm[11], rightShoulder = lm[12];
        const leftElbow = lm[13], rightElbow = lm[14]; // ÈúÄË¶ÅÊâãËÇòÁÆóËßíÂ∫¶
        const leftWrist = lm[15], rightWrist = lm[16];

        if (nose && leftShoulder && rightShoulder && leftElbow && rightElbow && leftWrist && rightWrist) {
          const shoulderWidth = calculateDistance(leftShoulder, rightShoulder);
          const stableScale = shoulderWidth * 2.5; 

          // [‰øÆÊîπ] Á∂†ÂúàÊé®ÈÅ†‰∏ÄÈªû (Âæû 0.6 ÊîπÁÇ∫ 0.8)
          // ÈÄôÊ®£Ë¶ñË¶∫‰∏ä‰Ω†ÊúÉË¶∫ÂæóË¶ÅÊâìÊØîËºÉÈÅ†ÔºåÁ¨¶ÂêàÁâ©ÁêÜË∑ùÈõ¢
          const targetX = (nose.x - (stableScale * 0.8)) * cw; 
          const targetY = nose.y * ch;

          canvasCtx.beginPath();
          canvasCtx.strokeStyle = "#00FF00"; canvasCtx.lineWidth = 4;
          canvasCtx.arc(targetX, targetY, 20, 0, 2 * Math.PI); canvasCtx.stroke();

          // Â∑¶ÊâãÈÅãÁÆó
          let leftSpeed = calculateDistance(leftWrist, prevLeftWrist);
          let leftAngle = calculateAngle(leftShoulder, leftElbow, leftWrist);
          leftStage = processHand(leftShoulder, leftWrist, stableScale, leftStage, "L", leftCooldown, CONFIG, leftSpeed, leftAngle);
          prevLeftWrist = { x: leftWrist.x, y: leftWrist.y };

          // Âè≥ÊâãÈÅãÁÆó
          let rightSpeed = calculateDistance(rightWrist, prevRightWrist);
          let rightAngle = calculateAngle(rightShoulder, rightElbow, rightWrist);
          rightStage = processHand(rightShoulder, rightWrist, stableScale, rightStage, "R", rightCooldown, CONFIG, rightSpeed, rightAngle);
          prevRightWrist = { x: rightWrist.x, y: rightWrist.y };
        }
      }
      canvasCtx.restore();
    }

    // [Ê†∏ÂøÉ] Âä†ÂÖ•ËßíÂ∫¶Âà§ÂÆö (angle)
    function processHand(shoulder, wrist, scale, currentStage, label, currentCooldown, config, speed, angle) {
      const wristDist = calculateDistance(shoulder, wrist);
      const ratio = wristDist / scale;
      let nextStage = currentStage;
      const isLeft = label === "L";

      if (currentStage === "down") {
        // [ÈóúÈçµÈÇèËºØ]
        // 1. Ë∑ùÈõ¢Ë¶ÅÂ§†ÈÅ† (ratio > 0.85)
        // 2. ÈÄüÂ∫¶Ë¶ÅÂ§†Âø´ (speed > 0.015)
        // 3. [Êñ∞Â¢û] ÊâãËÇòÂøÖÈ†àÊâìÁõ¥ (angle > 125) -> ÈÄôÊúÉÈÅéÊøæÊéâÊâÄÊúâË∫´È´îÂâçÂÇæ„ÄÅÊóãËΩâÈÄ†ÊàêÁöÑË™§Âà§
        if (currentCooldown === 0 && ratio > config.triggerRatio && speed > config.minSpeed && angle > config.minAngle) {
            nextStage = "punch";
        }
      }
      else if (currentStage === "punch") {
        if (ratio < config.triggerRatio) {
           count++;
           countElement.innerText = count;
           countElement.classList.remove('pop-effect');
           void countElement.offsetWidth;
           countElement.classList.add('pop-effect');
           playPunchSound();
           updateFireEffect(count);

           const color = isLeft ? "#00FFFF" : "#FFA500";
           spawnFloatingText(wrist.x, wrist.y, "+1", color);
           
           statusElement.innerText = isLeft ? "LEFT HIT!" : "RIGHT HIT!";
           statusElement.style.color = color;

           if (isLeft) leftCooldown = config.cooldownFrames;
           else rightCooldown = config.cooldownFrames;

           nextStage = "retract";
        }
      }
      else if (currentStage === "retract") {
        if (ratio < config.resetRatio) nextStage = "down"; 
      }

      return nextStage;
    }

    // --- ÂàùÂßãÂåñ ---
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({ modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    pose.onResults(onResults);

    window.initGame = async function() {
      console.log("ÂïüÂãï‰∏≠...");
      statusElement.innerText = "STARTING..."; statusElement.style.color = "yellow";
      await loadSound();
      if (audioContext && audioContext.state === 'suspended') await audioContext.resume();

      const camera = new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); }
      });

      try {
          await camera.start();
          statusElement.innerText = "READY"; statusElement.style.color = "white";
          startBtn.style.display = 'none'; resetBtn.style.display = 'block';
      } catch (e) {
          console.error(e);
          alert("Áõ∏Ê©üÂ§±ÊïóÔºåË´ãÁ¢∫Ë™çÁ∂≤ÂùÄ https Êàñ localhost");
          statusElement.innerText = "ERROR";
      }
    }
  </script>
</body>
</html>
