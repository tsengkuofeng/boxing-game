<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è–èª•æ‹³æ“Šç‰¹è¨“ V2 - Christmas Boxing</title>
<style>
/* =========================================
   ã€èƒŒæ™¯èˆ‡å ´æ™¯ã€‘
   ========================================= */
.scene-background {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  z-index: -1; overflow: hidden;
  background: linear-gradient(to bottom, #020111 10%, #191d3a 50%, #2d3e5e 90%);
}
.moon {
  position: absolute; top: 50px; right: 50px; width: 80px; height: 80px;
  background: #fefcd7; border-radius: 50%;
  box-shadow: 0 0 20px #fefcd7, 0 0 50px rgba(254, 252, 215, 0.4);
}
.snow-ground {
  position: absolute; bottom: 0; left: 0; width: 100%; height: 30%;
  background: #fffafa; border-top: 5px solid #e3e3e3;
  border-radius: 50% 50% 0 0 / 20px 20px 0 0;
}
.snowflake {
  position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.8;
  animation: fall linear infinite;
}
@keyframes fall {
  0% { top: -10%; transform: translateX(0); }
  100% { top: 100%; transform: translateX(20px); }
}
.snowflake:nth-child(2) { width: 8px; height: 8px; animation-duration: 7s; opacity: 0.6; }
.snowflake:nth-child(3) { width: 12px; height: 12px; animation-duration: 5s; opacity: 0.9; }
.snowflake:nth-child(4) { width: 6px; height: 6px; animation-duration: 8s; opacity: 0.5; }
.snowflake:nth-child(5) { width: 10px; height: 10px; animation-duration: 6s; opacity: 0.7; }

/* =========================================
   ã€UI ä»‹é¢ã€‘
   ========================================= */
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  text-align: center; margin: 0; overflow: hidden; color: #fff; background: transparent;
}
.container { position: relative; width: 100vw; height: 100vh; }
video, canvas { 
  position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
  object-fit: cover; transform: scaleX(-1); z-index: 0; 
}

/* è¨ˆåˆ†æ¿ */
.score-board { 
  position: absolute; top: 80px; left: 50%; transform: translateX(-50%); z-index: 10; 
  background: rgba(0, 0, 0, 0.6); padding: 10px 40px; border-radius: 20px; 
  border: 1px solid rgba(255, 255, 255, 0.3); pointer-events: none; transition: all 0.3s ease;
}
#count { font-size: 70px; font-weight: 800; color: #fff; line-height: 1; }
.count-title { font-size: 14px; color: #ccc; letter-spacing: 2px; }
#status { margin-top: 5px; font-size: 18px; font-weight: bold; color: #ddd; }

/* æŒ‰éˆ• */
#start-btn { 
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; 
  padding: 25px 50px; font-size: 30px; font-weight: 900; 
  background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: 4px solid rgba(255, 255, 255, 0.5); 
  border-radius: 60px; cursor: pointer; box-shadow: 0 0 30px rgba(0, 123, 255, 0.6); animation: pulse 1.5s infinite;
}
@keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.05); } 100% { transform: translate(-50%, -50%) scale(1); } }

#reset-btn {
  position: absolute; bottom: 40px; right: 20px; z-index: 100;
  background: #ff4757; color: white; border: 2px solid white; padding: 15px 30px; 
  font-size: 18px; font-weight: bold; border-radius: 30px; cursor: pointer; display: none; 
}
#reset-btn:active { transform: scale(0.9); }

/* ç‰¹æ•ˆèˆ‡RWD */
.pop-effect { animation: pop 0.1s ease-out; color: #00ff00 !important; }
@keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }

@media (max-height: 500px) and (orientation: landscape) {
  .score-board { top: 10px; left: 20px; transform: none; padding: 5px 20px; }
  #count { font-size: 40px; }
  #start-btn { padding: 15px 30px; font-size: 20px; }
  #reset-btn { bottom: auto; top: 10px; right: 20px; padding: 8px 15px; }
}
@media (min-width: 1024px) {
  .score-board { top: 60px; padding: 20px 80px; }
  #count { font-size: 140px; text-shadow: 0 0 30px currentColor; }
}

/* ç«ç„°ç­‰ç´š */
.fire-lv1 { border-color: #ffd700 !important; color: #ffd700 !important; box-shadow: 0 0 15px gold; }
.fire-lv2 { border-color: #ff4500 !important; color: #ff4500 !important; box-shadow: 0 0 30px orangered; }
.fire-lv3 { border-color: #00ffff !important; color: #00ffff !important; box-shadow: 0 0 40px cyan; }
</style>
</head>
<body>

<div class="scene-background">
  <div class="night-sky"><div class="moon"></div></div>
  <div class="snowflake" style="left: 10%; animation-delay: 0s;"></div>
  <div class="snowflake" style="left: 30%; animation-delay: 2s;"></div>
  <div class="snowflake" style="left: 50%; animation-delay: 4s;"></div>
  <div class="snowflake" style="left: 70%; animation-delay: 1s;"></div>
  <div class="snowflake" style="left: 90%; animation-delay: 3s;"></div>
  <div class="snow-ground"></div>
</div>

<div class="container">
  <div class="score-board">
    <div class="count-title">TOTAL HITS</div>
    <div id="count">0</div>
    <div id="status">READY</div>
  </div>

  <div class="video-container">
    <video id="input_video" playsinline></video>
    <canvas id="output_canvas"></canvas>
  </div>

  <button id="start-btn" onclick="startCamera()">ğŸ¥Š é»æ“Šé–‹å§‹ (START)</button>
  <button id="reset-btn" onclick="resetCount()">æ­¸é›¶é‡ç½® (RESET)</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
// --- 0. éŸ³æ•ˆè¨­å®š (å–®ä¸€æª”æ¡ˆ punch.mp3) ---
// è­¦å‘Šï¼šè«‹ç¢ºä¿ punch.mp3 èˆ‡æ­¤ HTML åœ¨åŒä¸€ç›®éŒ„ä¸‹
const punchAudioBase = new Audio('punch.mp3');

// é å…ˆè¼‰å…¥
punchAudioBase.load();

function playHitSound(type) {
    // è¤‡è£½éŸ³è¨Šç¯€é»ä»¥å…è¨±é‡ç–Šæ’­æ”¾
    let clone = punchAudioBase.cloneNode();
    clone.volume = 0.8;
    
    if (type === 'heavy') {
        // é‡æ‹³ï¼šç¨å¾®æ”¾æ…¢é€Ÿåº¦ï¼Œè²éŸ³æœƒè®Šä½æ²‰
        clone.playbackRate = 0.9; 
    } else {
        // è¼•æ‹³ï¼šç¨å¾®åŠ å¿«é€Ÿåº¦ï¼Œè²éŸ³æœƒè®Šæ¸…è„†
        clone.playbackRate = 1.2; 
    }
    
    clone.play().catch(e => console.log("Audio play failed:", e));
}

// --- 1. è®Šæ•¸èˆ‡è¨­å®š ---
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const countElement = document.getElementById('count');
const scoreBoard = document.querySelector('.score-board'); 
const statusElement = document.getElementById('status');
const startBtn = document.getElementById('start-btn'); 
const resetBtn = document.getElementById('reset-btn'); 

// ã€æ­£é¢åˆ¤å®šåƒæ•¸èª¿æ•´ã€‘
// æ­£é¢æ‰“æ‹³æ™‚ï¼Œæ‰‹ä¼¸ç›´çš„è¦–è¦ºæ¯”ä¾‹æœƒå› ç‚ºé€è¦–è®ŠçŸ­ï¼Œæ‰€ä»¥ triggerRatio è¦èª¿å°
const FRONT_PUNCH_CONFIG = {
  // è§¸ç™¼åˆ¤å®šï¼šæ‰‹è…•é›¢è‚©è†€çš„è·é›¢ / è‚©å¯¬
  // 0.55 ä»£è¡¨æ‰‹ä¼¸å‡ºä¸€åŠä»¥ä¸Šå°±ç®—ï¼Œæ­£é¢é€è¦–ä¸‹é€™å·²ç¶“å¾ˆé•·äº†
  triggerRatio: 0.55, 
  
  // ç¸®å›åˆ¤å®šï¼šæ‰‹å›åˆ°èº«é«”é™„è¿‘
  resetRatio: 0.40,
  
  // å†·å»æ™‚é–“ (Frames)
  cooldownFrames: 4,
  
  // é˜²èª¤åˆ¤ï¼šæ‰‹å¿…é ˆé«˜æ–¼è…°éƒ¨ (æ‰‹è…•.y < æ‰‹è‚˜.y + tolerance)
  // æ­£é¢æ™‚ y è»¸åˆ¤æ–·æ¯”è§’åº¦åˆ¤æ–·æ›´æº–
  elevationTolerance: 0.2 
};

let count = 0;
let leftStage = "down"; 
let rightStage = "down";
let leftCooldown = 0;
let rightCooldown = 0;
let floatingTexts = []; 

// --- 2. å·¥å…·å‡½æ•¸ ---
function calculateDistance(a, b) {
  return Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2));
}

function drawVisualText(ctx, text, visualX, visualY, color, fontSize = "24px") {
  ctx.save();
  const internalX = ctx.canvas.width - visualX;
  ctx.translate(internalX, visualY);
  ctx.scale(-1, 1); 
  ctx.font = `900 ${fontSize} Arial`;
  ctx.fillStyle = color;
  ctx.strokeStyle = "black";
  ctx.lineWidth = 2;
  ctx.strokeText(text, 0, 0);
  ctx.fillText(text, 0, 0); 
  ctx.restore();
}

function spawnFloatingText(x, y, text, color) {
  floatingTexts.push({ x, y, text, color, life: 20, offsetY: 0 });
}

function updateFireEffect(currentCount) {
  if (!scoreBoard) return;
  scoreBoard.classList.remove('fire-lv1', 'fire-lv2', 'fire-lv3');
  if (currentCount >= 100) scoreBoard.classList.add('fire-lv3');
  else if (currentCount >= 50) scoreBoard.classList.add('fire-lv2');
  else if (currentCount >= 20) scoreBoard.classList.add('fire-lv1');
}

window.resetCount = function() {
  count = 0; 
  countElement.innerText = count; 
  floatingTexts = []; 
  leftCooldown = 0; rightCooldown = 0;
  leftStage = "down"; rightStage = "down";
  if (scoreBoard) scoreBoard.classList.remove('fire-lv1', 'fire-lv2', 'fire-lv3');
  statusElement.innerText = "RESET OK"; 
  statusElement.style.color = "white";
}

// --- 3. æ ¸å¿ƒåµæ¸¬é‚è¼¯ ---
function onResults(results) {
  canvasElement.width = videoElement.videoWidth;
  canvasElement.height = videoElement.videoHeight;
  const cw = canvasElement.width;
  const ch = canvasElement.height;

  canvasCtx.save();
  canvasCtx.clearRect(0, 0, cw, ch);
  // ç¹ªè£½åŠé€æ˜å½±åƒ
  canvasCtx.globalAlpha = 0.8;
  canvasCtx.drawImage(results.image, 0, 0, cw, ch);
  canvasCtx.globalAlpha = 1.0;

  // æµ®å‹•æ–‡å­—æ›´æ–°
  for (let i = floatingTexts.length - 1; i >= 0; i--) {
    let ft = floatingTexts[i];
    ft.life--; ft.offsetY -= 3;
    const visualX = cw - ft.x; 
    drawVisualText(canvasCtx, ft.text, visualX, ft.y + ft.offsetY, ft.color, "50px");
    if (ft.life <= 0) floatingTexts.splice(i, 1);
  }

  if (leftCooldown > 0) leftCooldown--;
  if (rightCooldown > 0) rightCooldown--;

  if (results.poseLandmarks) {
    // ç°¡å–®ç•«éª¨æ¶
    drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: 'rgba(255, 255, 255, 0.3)', lineWidth: 2});
    
    const lm = results.poseLandmarks;
    const nose = lm[0];
    const leftShoulder = lm[11];
    const rightShoulder = lm[12];
    const leftElbow = lm[13];
    const rightElbow = lm[14];
    const leftWrist = lm[15];
    const rightWrist = lm[16];

    if (leftShoulder && rightShoulder) {
      // åŸºæº–å°ºï¼šè‚©å¯¬ (é€™æ˜¯ç›¸å°ç©©å®šçš„é•·åº¦)
      const shoulderWidth = calculateDistance(leftShoulder, rightShoulder);
      
      // æˆ‘å€‘ä¸ç•«åœ“åœˆäº†ï¼Œå› ç‚ºæ­£é¢æ‰“æ“Šæ˜¯ä»»æ„æ–¹å‘
      // åªéœ€è¦ç°¡å–®çš„æç¤ºæ–‡å­—
      // drawVisualText(canvasCtx, "BOXING MODE", cw/2, 50, "#FFF", "20px");

      // å·¦æ‰‹è™•ç†
      if (leftWrist && leftElbow && leftWrist.visibility > 0.5) {
        leftStage = processFrontHand(leftShoulder, leftWrist, leftElbow, shoulderWidth, leftStage, "L", leftCooldown);
      }
      
      // å³æ‰‹è™•ç†
      if (rightWrist && rightElbow && rightWrist.visibility > 0.5) {
        rightStage = processFrontHand(rightShoulder, rightWrist, rightElbow, shoulderWidth, rightStage, "R", rightCooldown);
      }
    }
  }
  canvasCtx.restore();
}

// æ­£é¢æ‰“æ“Šåˆ¤å®šé‚è¼¯
function processFrontHand(shoulder, wrist, elbow, scale, currentStage, label, cooldown) {
  // 1. è¨ˆç®—æ‰‹è…•åˆ°è‚©è†€çš„è·é›¢ (Normalized by Shoulder Width)
  const dist = calculateDistance(shoulder, wrist);
  const ratio = dist / scale;
  
  // 2. é«˜åº¦æª¢æŸ¥ï¼šæ‰‹è…•ä¸èƒ½æ‰åˆ°å¤ªä¸‹é¢ (é˜²æ­¢æ”¾ä¸‹æ‰‹æ™‚èª¤åˆ¤)
  // MediaPipe Yè»¸å‘ä¸‹æ˜¯æ­£ï¼Œæ‰€ä»¥ wrist.y < elbow.y ä»£è¡¨æ‰‹èˆ‰èµ·ä¾†
  // æˆ‘å€‘æ”¾å¯¬ä¸€é»ï¼ŒåŠ ä¸Š tolerance
  const isHighEnough = wrist.y < (elbow.y + FRONT_PUNCH_CONFIG.elevationTolerance);

  let nextStage = currentStage;

  // ç‹€æ…‹æ©Ÿ
  if (currentStage === "down") {
    // æº–å‚™ç‹€æ…‹ -> å‡ºæ‹³
    // æ¢ä»¶ï¼šæ‰‹ä¼¸é•· + æ‰‹æœ‰èˆ‰é«˜ + å†·å»çµæŸ
    if (ratio > FRONT_PUNCH_CONFIG.triggerRatio && isHighEnough && cooldown === 0) {
      nextStage = "punch";
    }
  }
  else if (currentStage === "punch") {
    // å‡ºæ‹³ç‹€æ…‹ -> æ”¶æ‹³ (æˆ–åˆ¤å®šæ“Šä¸­)
    // é€™è£¡æˆ‘å€‘ç°¡åŒ–ï¼šåªè¦ä¸€é”åˆ° punch ç‹€æ…‹å°±ç®—æ“Šä¸­ï¼Œç„¶å¾Œå¼·åˆ¶é€²å…¥ retract é¿å…é€£ç™¼
    
    // === æ“Šä¸­åˆ¤å®š ===
    count++;
    countElement.innerText = count;
    
    // UIç‰¹æ•ˆ
    countElement.classList.remove('pop-effect'); 
    void countElement.offsetWidth; 
    countElement.classList.add('pop-effect'); 
    updateFireEffect(count);

    // éŸ³æ•ˆ (Punch.mp3)
    // å·¦æ‰‹ç•¶åˆºæ‹³(è¼•)ï¼Œå³æ‰‹ç•¶é‡æ‹³(é‡)
    if (label === "L") {
       playHitSound('light'); 
    } else {
       playHitSound('heavy'); 
    }

    // è¨­å®šå†·å»
    if (label === "L") leftCooldown = FRONT_PUNCH_CONFIG.cooldownFrames;
    else rightCooldown = FRONT_PUNCH_CONFIG.cooldownFrames;

    // æµ®å‹•æ–‡å­—
    const hitX = wrist.x * canvasElement.width;
    const hitY = wrist.y * canvasElement.height;
    const color = label === "L" ? "#00FFFF" : "#FFA500"; 
    spawnFloatingText(hitX, hitY, "+1", color);
    
    statusElement.innerText = label === "L" ? "LEFT HIT!" : "RIGHT HIT!";
    statusElement.style.color = color;

    nextStage = "retract";
  }
  else if (currentStage === "retract") {
    // æ”¶æ‹³ç‹€æ…‹ -> å›åˆ°æº–å‚™
    // æ¢ä»¶ï¼šæ‰‹ç¸®å›åˆ°èº«é«”é™„è¿‘
    if (ratio < FRONT_PUNCH_CONFIG.resetRatio) {
      nextStage = "down"; 
    }
  }

  return nextStage;
}

// --- åˆå§‹åŒ– ---
const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
pose.onResults(onResults);

// --- å•Ÿå‹• ---
window.startCamera = function() {
  // è§£é–éŸ³æ•ˆ (æ’­æ”¾ç¬é–“éœéŸ³)
  punchAudioBase.play().then(() => {
    punchAudioBase.pause();
    punchAudioBase.currentTime = 0;
  }).catch(e => console.log("Audio unlock failed", e));

  const camera = new Camera(videoElement, {
    onFrame: async () => { await pose.send({image: videoElement}); },
    width: 640, height: 480
  });
  camera.start();
  
  document.getElementById('start-btn').style.display = 'none'; 
  document.getElementById('reset-btn').style.display = 'block';
}
</script>
</body>
</html>
