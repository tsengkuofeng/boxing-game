<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V14 æ¥µé€Ÿé€£æ“Šç‰ˆ</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    /* --- åŸºç¤è¨­å®š --- */
    body { 
      font-family: 'Segoe UI', sans-serif; 
      background: #000; margin: 0; overflow: hidden; user-select: none;
    }
    .container { position: relative; width: 100vw; height: 100vh; }
    video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    
    .scene-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; background: radial-gradient(circle, #222 0%, #000 90%); }

    /* --- è¨ˆåˆ†æ¿æ ¸å¿ƒå®¹å™¨ --- */
    .score-board { 
      position: absolute; top: 30px; left: 50%; transform: translateX(-50%); z-index: 10; 
      padding: 10px 50px; border-radius: 20px; 
      text-align: center; transition: all 0.2s ease-out;
      /* é è¨­æ¨£å¼ */
      background: rgba(0, 0, 0, 0.6); 
      border: 2px solid #444;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    
    .count-label { font-size: 14px; color: #888; letter-spacing: 4px; font-weight: bold; text-transform: uppercase; }
    #count { font-size: 110px; font-weight: 900; line-height: 1; color: #fff; text-shadow: 0 5px 10px rgba(0,0,0,0.5); }

    /* --- ç‰¹æ•ˆåˆ†ç´šç³»çµ± (Tier System) --- */

    /* LV1: 30-50 (æš–èº« - è—è‰²æ°£å ´) */
    .score-board.tier-1 {
        border-color: #00d2ff;
        background: rgba(0, 30, 60, 0.7);
        box-shadow: 0 0 20px #00d2ff, inset 0 0 20px rgba(0, 210, 255, 0.2);
    }
    .tier-1 #count { color: #e0f7fa; text-shadow: 0 0 15px #00d2ff; }

    /* LV2: 50-70 (é€²å…¥ç‹€æ…‹ - é‡‘é»ƒè‰² + è¼•å¾®å‘¼å¸) */
    .score-board.tier-2 {
        border-color: #ffd700;
        background: rgba(60, 50, 0, 0.7);
        box-shadow: 0 0 30px #ffd700, inset 0 0 30px rgba(255, 215, 0, 0.2);
        animation: breath 0.5s infinite alternate;
    }
    .tier-2 #count { color: #fffde7; text-shadow: 0 0 20px #ffd700; }

    /* LV3: 70-100 (ç‡ƒç‡’ - æ©˜ç´…è‰² + æ™ƒå‹•) */
    .score-board.tier-3 {
        border-color: #ff4500;
        background: rgba(60, 10, 0, 0.8);
        box-shadow: 0 0 40px #ff4500, 0 0 80px rgba(255, 69, 0, 0.4);
        animation: shake-mild 0.3s infinite;
    }
    .tier-3 #count { color: #ffccbc; text-shadow: 0 0 25px #ff4500; }

    /* LV4: 100-150 (æš´èµ° - ç´«è‰²é›»æ¼¿ + å¼·çƒˆæ™ƒå‹•) */
    .score-board.tier-4 {
        border-color: #d63031;
        background: linear-gradient(135deg, rgba(100,0,0,0.9), rgba(50,0,0,0.9));
        box-shadow: 0 0 50px #ff0000, 0 0 100px #ff0000;
        animation: shake-hard 0.2s infinite;
    }
    .tier-4 #count { color: #ffadad; text-shadow: 0 0 30px #ff0000, 0 0 10px #fff; }

    /* LV5: 150+ (ç¥ä¹‹é ˜åŸŸ - å¹»å½©æ•…éšœé¢¨) */
    .score-board.tier-5 {
        border: 5px solid #fff;
        background: #000;
        box-shadow: 0 0 60px #fff, 0 0 100px #ff00ff, 0 0 150px #00ffff;
        animation: glitch-anim 0.1s infinite;
    }
    .tier-5 #count { color: #fff; text-shadow: 2px 2px 0px #ff00ff, -2px -2px 0px #00ffff; }

    /* --- å‹•ç•« Keyframes --- */
    @keyframes breath { 0% { transform: translateX(-50%) scale(1); } 100% { transform: translateX(-50%) scale(1.05); } }
    @keyframes shake-mild { 0% { transform: translateX(-52%) rotate(-1deg); } 50% { transform: translateX(-48%) rotate(1deg); } 100% { transform: translateX(-50%) rotate(0deg); } }
    @keyframes shake-hard { 0% { transform: translate(-53%, 2px) rotate(-2deg); } 25% { transform: translate(-47%, -2px) rotate(2deg); } 50% { transform: translate(-52%, -1px) rotate(-1deg); } 75% { transform: translate(-48%, 1px) rotate(1deg); } 100% { transform: translate(-50%, 0); } }
    @keyframes glitch-anim { 0% { clip-path: inset(10% 0 80% 0); transform: translateX(-51%); } 20% { clip-path: inset(80% 0 5% 0); transform: translateX(-49%); } 40% { clip-path: inset(30% 0 10% 0); transform: translateX(-52%); } 60% { clip-path: inset(10% 0 40% 0); transform: translateX(-48%); } 80% { clip-path: inset(50% 0 20% 0); transform: translateX(-50%); } 100% { clip-path: inset(0 0 0 0); } }
    
    /* æ“Šä¸­æ™‚çš„ç¬é–“æ”¾å¤§æ•ˆæœ (ç¨ç«‹æ–¼æŒçºŒå‹•ç•«) */
    .hit-pop { animation: pop-scale 0.08s ease-out; }
    @keyframes pop-scale { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

    /* é˜²ç¦¦ç‹€æ…‹ */
    .status-bar { display: flex; justify-content: space-between; margin-top: 10px; width: 300px; margin-left: auto; margin-right: auto;}
    .guard-indicator { 
        width: 15px; height: 15px; border-radius: 50%; background: #333; border: 2px solid #555;
        box-shadow: 0 0 5px #000; transition: all 0.1s;
    }
    .guard-indicator.active { background: #00ff00; border-color: #fff; box-shadow: 0 0 10px #00ff00; }
    
    #start-btn, #reset-btn { position: absolute; z-index: 100; cursor: pointer; border: none; font-weight: bold; border-radius: 50px; color: white;}
    #start-btn { top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 60px; font-size: 24px; background: #007bff; box-shadow: 0 0 30px rgba(0,123,255,0.5); }
    #reset-btn { bottom: 30px; right: 30px; padding: 10px 20px; background: #ff4757; display: none; }
  </style>
</head>

<body>
  <div class="scene-bg"></div>

  <div class="container">
    <div class="score-board" id="score-board">
      <div class="count-label">COMBO</div>
      <div id="count">0</div>
      
      <div class="status-bar">
          <div id="led-left" class="guard-indicator"></div>
          <div id="led-right" class="guard-indicator"></div>
      </div>
    </div>

    <div class="video-container">
      <video id="input_video" playsinline style="display:none"></video>
      <canvas id="output_canvas"></canvas>
    </div>

    <button id="start-btn" onclick="initGame()">ğŸ¥Š å•Ÿå‹•æ¥µé€Ÿé€£æ“Š</button>
    <button id="reset-btn" onclick="resetCount()">RESET</button>
  </div>

  <script>
    // --- éŸ³æ•ˆç³»çµ± ---
    const PUNCH_SOUND_URL = 'punch.mp3'; 
    let audioContext = null, punchBuffer = null;
    async function loadSound() {
        try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
            const res = await fetch(PUNCH_SOUND_URL);
            const buf = await res.arrayBuffer();
            punchBuffer = await audioContext.decodeAudioData(buf);
        } catch(e) {}
    }
    function playPunchSound() {
        if (!audioContext || !punchBuffer) return;
        if (audioContext.state === 'suspended') audioContext.resume();
        const src = audioContext.createBufferSource();
        src.buffer = punchBuffer;
        src.connect(audioContext.destination);
        // åŠ å…¥ä¸€é»éŸ³èª¿è®ŠåŒ–ï¼Œè®“é€£æ“Šè½èµ·ä¾†æ›´è±å¯Œ
        src.playbackRate.value = 0.9 + Math.random() * 0.2;
        src.start(0);
    }

    // --- V14 åƒæ•¸è¨­å®š (é‡å° 4æ‹³/ç§’ å„ªåŒ–) ---
    const CONFIG = {
        // [è§¸ç™¼é–€æª»]
        // åˆ¤å®šæ‰‹è…•ä¼¸å‡º (Zè»¸æ·±åº¦å·®)
        triggerZ: 0.35, 

        // [é‡ç½®é–€æª» - é—œéµå„ªåŒ–]
        // åŸæœ¬å¯èƒ½è¦æ”¶åˆ° 0.1 æ‰é‡ç½®ï¼Œç¾åœ¨åªè¦å›åˆ° 0.28 å°±é‡ç½®
        // é€™æ¨£å…è¨±ã€ŒåŠç¨‹é€£æ“Šã€(Rabbit Punch)
        resetZ: 0.28, 

        // [å†·å»å¹€æ•¸]
        // 30FPSä¸‹ï¼Œ2å¹€ç´„ç‚º 66msã€‚äººæ‰‹æœ€å¿«ç´„ 200ms ä¸€æ‹³ï¼Œè¨­ç½®æ¥µä½ä»¥é˜²æ¼æ¥
        cooldownFrames: 2, 

        // é˜²ç¦¦åˆ¤å®šè·é›¢ (ç¶­æŒåŸæ¨£)
        guardDistRatio: 0.65 
    };

    // ç‹€æ…‹è®Šæ•¸
    let count = 0;
    let leftState = 0; // 0: Ready, 1: Punching, 2: Retracting
    let rightState = 0;
    let leftCooldown = 0, rightCooldown = 0;
    let leftGuardGrace = 0, rightGuardGrace = 0;
    
    // UI å…ƒç´ 
    const scoreBoard = document.getElementById('score-board');
    const countEl = document.getElementById('count');
    const ledLeft = document.getElementById('led-left');
    const ledRight = document.getElementById('led-right');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const video = document.getElementById('input_video');
    
    // æµ®å‹•æ–‡å­—æ± 
    let floatTexts = [];

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function updateState(shoulder, wrist, nose, scale, state, cooldown, isOppositeGuarding, label) {
        // 1. è¨ˆç®— Z è»¸è¡ç¨‹ (æ­£å€¼è¶Šå¤§ä»£è¡¨æ‰‹è¶Šé è¿‘é¡é ­)
        const zStroke = shoulder.z - wrist.z;
        let newState = state;
        let hit = false;

        // ç‹€æ…‹æ©Ÿå„ªåŒ–
        if (state === 0) { // Ready
            // è§¸ç™¼æ¢ä»¶ï¼šè¡ç¨‹å¤ æ·± + æ²’æœ‰å†·å» + å°å‘æ‰‹æœ‰é˜²ç¦¦
            if (zStroke > CONFIG.triggerZ && cooldown <= 0 && isOppositeGuarding) {
                newState = 1; // Punch
                hit = true;
            }
        } 
        else if (state === 1) { // Punching
            // é¦¬ä¸Šé€²å…¥å›æ”¶ç›£æ§
            newState = 2; 
        } 
        else if (state === 2) { // Retracting
            // [é—œéµ] åªè¦è¡ç¨‹ç¨å¾®ç¸®å›ä¾†å°æ–¼ resetZï¼Œç«‹åˆ»é‡ç½®ç‚º Ready
            if (zStroke < CONFIG.resetZ) {
                newState = 0;
            }
        }

        return { newState, hit };
    }

    function updateUIEffect() {
        // å…ˆç§»é™¤æ‰€æœ‰ tier class
        scoreBoard.classList.remove('tier-1', 'tier-2', 'tier-3', 'tier-4', 'tier-5');
        
        // æ ¹æ“š count åŠ å…¥å°æ‡‰ class
        if (count >= 150) scoreBoard.classList.add('tier-5');
        else if (count >= 100) scoreBoard.classList.add('tier-4');
        else if (count >= 70) scoreBoard.classList.add('tier-3');
        else if (count >= 50) scoreBoard.classList.add('tier-2');
        else if (count >= 30) scoreBoard.classList.add('tier-1');
        
        // æ•¸å­—è·³å‹• (åˆ©ç”¨ reflow é‡ç½®å‹•ç•«)
        countEl.classList.remove('hit-pop');
        void countEl.offsetWidth; 
        countEl.classList.add('hit-pop');
    }

    function spawnFloatText(x, y, isLeft) {
        if (floatTexts.length > 15) floatTexts.shift();
        floatTexts.push({
            x, y, 
            text: count, 
            color: isLeft ? '#00d2ff' : '#ff9f43',
            life: 20, 
            vy: -3 
        });
    }

    // --- å¹€è™•ç†è¿´åœˆ ---
    function onResults(results) {
        // 1. ç¹ªè£½ç•«é¢
        const cw = canvas.width; const ch = canvas.height;
        ctx.save();
        ctx.clearRect(0, 0, cw, ch);
        ctx.drawImage(results.image, 0, 0, cw, ch);

        // 2. è™•ç† MediaPipe æ•¸æ“š
        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            const nose = lm[0];
            const leftS = lm[11], rightS = lm[12];
            const leftW = lm[15], rightW = lm[16];
            
            if (nose && leftS && rightS && leftW && rightW) {
                // è¨ˆç®—æ¯”ä¾‹å°º (è‚©è†€å¯¬åº¦)
                const shoulderDist = Math.hypot(leftS.x - rightS.x, leftS.y - rightS.y);
                const scale = shoulderDist * 2.5;
                const chin = { x: (lm[9].x + lm[10].x)/2, y: (lm[9].y + lm[10].y)/2 };

                // --- A. é˜²ç¦¦åµæ¸¬ ---
                const guardThresh = scale * CONFIG.guardDistRatio;
                const distL = Math.hypot(leftW.x - chin.x, leftW.y - chin.y);
                const distR = Math.hypot(rightW.x - chin.x, rightW.y - chin.y);

                // å¯¬å®¹è¨ˆæ™‚å™¨ (æ‰‹ç¨å¾®é›¢é–‹ä¸€ä¸‹ä¸‹ä¸ç®—é˜²ç¦¦å¤±æ•—ï¼Œé˜²æ­¢éœ‡å‹•èª¤åˆ¤)
                if (distL < guardThresh) leftGuardGrace = 5; else if (leftGuardGrace > 0) leftGuardGrace--;
                if (distR < guardThresh) rightGuardGrace = 5; else if (rightGuardGrace > 0) rightGuardGrace--;

                const isGuardL = leftGuardGrace > 0;
                const isGuardR = rightGuardGrace > 0;

                // æ›´æ–°é˜²ç¦¦ç‡ˆè™Ÿ
                if (isGuardL) ledLeft.classList.add('active'); else ledLeft.classList.remove('active');
                if (isGuardR) ledRight.classList.add('active'); else ledRight.classList.remove('active');

                // --- B. æ‹³æ“Šåˆ¤å®š (æ ¸å¿ƒ) ---
                const resL = updateState(leftS, leftW, nose, scale, leftState, leftCooldown, isGuardR, 'L');
                const resR = updateState(rightS, rightW, nose, scale, rightState, rightCooldown, isGuardL, 'R');

                leftState = resL.newState;
                rightState = resR.newState;

                // è™•ç†å‘½ä¸­
                if (resL.hit) {
                    count++;
                    leftCooldown = CONFIG.cooldownFrames;
                    updateUIEffect();
                    playPunchSound();
                    spawnFloatText(leftW.x, leftW.y, true);
                    countEl.innerText = count;
                }
                if (resR.hit) {
                    count++;
                    rightCooldown = CONFIG.cooldownFrames;
                    updateUIEffect();
                    playPunchSound();
                    spawnFloatText(rightW.x, rightW.y, false);
                    countEl.innerText = count;
                }

                // æ¸›å°‘å†·å»
                if (leftCooldown > 0) leftCooldown--;
                if (rightCooldown > 0) rightCooldown--;
            }
        }

        // 3. ç¹ªè£½æµ®å‹•æ–‡å­—
        ctx.scale(-1, 1); // é¡åƒæ–‡å­—ä¿®æ­£
        ctx.font = "900 60px sans-serif";
        ctx.lineWidth = 3;
        ctx.strokeStyle = "white";
        
        for (let i = floatTexts.length - 1; i >= 0; i--) {
            let t = floatTexts[i];
            const renderX = -(cw - (t.x * cw)); // é¡åƒ X åº§æ¨™è½‰æ›
            const renderY = (t.y * ch);
            
            ctx.fillStyle = t.color;
            ctx.strokeText(t.text, renderX, renderY);
            ctx.fillText(t.text, renderX, renderY);
            
            t.y += t.vy / ch; // ç§»å‹•
            t.life--;
            if (t.life <= 0) floatTexts.splice(i, 1);
        }
        ctx.restore();
    }

    // --- å•Ÿå‹• ---
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({
        modelComplexity: 1, // é«˜é€Ÿæ¨¡å¼å»ºè­°ç”¨ 1ï¼ŒMSI Vector å¯è·‘æ»¿ 30-60 FPS
        smoothLandmarks: true,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
    });
    pose.onResults(onResults);

    async function initGame() {
        await loadSound();
        const camera = new Camera(video, {
            onFrame: async () => { await pose.send({image: video}); },
            width: 1280, height: 720
        });
        await camera.start();
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('reset-btn').style.display = 'block';
    }

    window.resetCount = function() {
        count = 0;
        countEl.innerText = 0;
        updateUIEffect(); // é‡ç½®ç‰¹æ•ˆ
    }
  </script>
</body>
</html>
